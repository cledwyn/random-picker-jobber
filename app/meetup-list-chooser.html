<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/font-roboto/roboto.html">
<link rel="import" href="../components/paper-fab/paper-fab.html">
<link rel="import" href="../components/paper-ripple/paper-ripple.html">
<link rel="import" href="../components/paper-shadow/paper-shadow.html">
<link rel="import" href="../components/paper-button/paper-button.html" >
<link rel="import" href="../components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="meetup-service.html">
<script src="../components/web-animations-js/web-animations.js"></script>

<polymer-element name="meetup-list-chooser" >
  <template>
    <style>
      :host {
        font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial;
        display: block;
        width: 100%;
      }
      .attendeecard{
        width: 150px;
        height: 150px;
        margin:20px;
      }
      h3{     
        font-family: Roboto;
        font-weight: 100;
        font-size: 1.4em;
      }
      .img{
        max-width: 100px;
        max-height: 100px;
      }
      .imgfinal{
        height:200px;
        padding:6px;
        -webkit-border-radius: 4px;
      }
      .tall-toolbar {
      box-sizing: border-box;
      height: 250px;
    }

    .tall-toolbar.colored {
      fill: #fff;
      color: #fff;
    }

    .tall-toolbar [flex] {
      font-size: 1.5em;
    }
    .body{
      background-color: lightgrey;
      height: 250px;
    }

    </style>

    <meetup-service id="meetupservice" attendees="{{attendees}}"></meetup-service>

    <paper-button raised on-click="{{startJobber}}">Start</paper-button>
    <paper-button raised on-click="{{restartJobber}}">ReStart</paper-button>

    <core-animated-pages id="pages" selected="{{page}}" selectedItem="{{selectedItem}}" transitions="hero-transition" no-transition?="{{noTransition}}">

      <section id="page1" cross-fade>
        <div horizontal  layout wrap>
          <template repeat="{{membr in attendees}}">

            <div id="member{{membr.member.id}}" class="attendeecard"  layout center vertical hidden?="{{membr.done}}" >
              <paper-shadow z="3" fit  hidden?="{{membr.done}}"></paper-shadow>
              <div style="background-color:{{membr.bgcolorval}}" style="background-color:{{membr.bgcolorval}}" layout center vertical fit>
              <paper-ripple hidden?="{{membr.done}}" fit></paper-ripple>
              <img src="{{membr.member.photo.thumb}}" class="img" />
              <h3>{{membr.member.name}}</h3>
              </div>
            </div>
          </template>
        </div>
      </section>
      <section id="page2">
        <div class="tall-toolbar colored" style="background-color:orange;" layout vertical hero-id="thing" hero?="{{page === 0 || !noTransition}}">
        <div style="margin-left:auto; margin-right:auto; width:200px">
            <img src="{{winnerImg}}" class="imgfinal" />
        </div>
        <div style="margin-left:auto; margin-right:auto; width:200px">
          <h1>{{winnerName}}</h1>
        </div>
      </div>
      <div flex class="body"></div>
      </section>
  </template>

  <script>
  // lovley randomizer care of StackOverflow.... somewhere.
  function pastelColors(){
    var r = (Math.round(Math.random()* 127) + 127).toString(16);
    var g = (Math.round(Math.random()* 127) + 127).toString(16);
    var b = (Math.round(Math.random()* 127) + 127).toString(16);
    return '#' + r + g + b;
  }

  Polymer('meetup-list-chooser', {
    selectedItem: null,
    noTransition: true,
    publish: {
      page: {value: 0}
    },
    created: function() {
      this.attendees = [];
      this.winnerImg = "";
      this.winnerName = "";
    },
    ready: function() {
      this.page = 0;
      this.attendees = this.$.meetupservice.attendees;
    },
    restartJobber: function(){
      this.page = 0;
      this.attendees.forEach(function(mem){
        mem.bgcolorval = "white";
        mem.done = false;
      });
    },
    startJobber: function(){
      this.attendees.forEach(function(mem){
        mem.bgcolorval = pastelColors();  //recolor the background
        mem.done = mem.done || (Math.random() < .1);  // 10% chance of getting voted off
      });

      remaining = this.attendees.filter(function(el){ return el.done != true; }).length;
      // catch case when all are gone :/
      if(remaining == 0){
        this.restartJobber();
        remaining = 2;
      }
      if(remaining == 1){
        winner = this.attendees.filter(function(el){ return el.done != true; })[0];
        this.winnerImg = winner.member.photo.thumb;
        this.winnerName = winner.member.name;
        this.page = 1;
      }
      if (remaining > 1){
        this.async(function() {
          this.startJobber();
        }, null, 200);
      }
    }
  });
  </script>
</polymer-element>
